<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Motor Controller</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
        }
        .control-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .status {
            font-size: 1.2em;
            margin: 10px 0;
        }
        .speed-value {
            font-weight: bold;
            color: #e74c3c;
        }
        .position-value {
            font-weight: bold;
            color: #3498db;
        }
        .slider-container {
            margin: 20px 0;
        }
        .speed-slider {
            width: 100%;
        }
        .connection-status {
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
        }
        .connected {
            background-color: #2ecc71;
            color: white;
        }
        .disconnected {
            background-color: #e74c3c;
            color: white;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .connection-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ESP32 Motor Controller</h1>
        
        <div id="connectionStatus" class="connection-status disconnected">
            Not Connected
        </div>
        
        <div class="control-panel">
            <div class="control-section">
                <h2>Motor Control</h2>
                <div class="slider-container">
                    <label for="speedControl">Speed: <span id="speedDisplay">0</span>%</label>
                    <input type="range" id="speedControl" class="speed-slider" min="-100" max="100" value="0" step="1">
                </div>
                <div class="connection-buttons">
                    <button id="setSpeedBLE">Set Speed via BLE</button>
                    <button id="setSpeedWiFi">Set Speed via WiFi</button>
                </div>
            </div>
            
            <div class="control-section">
                <h2>Motor Status</h2>
                <div class="status">
                    Current Speed: <span id="currentSpeed" class="speed-value">0</span> RPM
                </div>
                <div class="status">
                    Current Position: <span id="currentPosition" class="position-value">0</span> revolutions
                </div>
                <button id="refreshStatus">Refresh Status</button>
            </div>
            
            <div class="control-section" id="bleSection">
                <h2>Bluetooth Connection</h2>
                <button id="connectBLE">Connect to ESP32</button>
                <button id="disconnectBLE" class="hidden">Disconnect</button>
                <div id="bleDevices" class="hidden">
                    <h3>Available Devices:</h3>
                    <select id="bleDeviceList"></select>
                    <button id="connectToDevice">Connect</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket and BLE variables
        let webSocket;
        let bleDevice = null;
        let bleServer = null;
        let bleService = null;
        let speedCharacteristic = null;
        let encoderCharacteristic = null;
        
        // DOM elements
        const speedControl = document.getElementById('speedControl');
        const speedDisplay = document.getElementById('speedDisplay');
        const currentSpeed = document.getElementById('currentSpeed');
        const currentPosition = document.getElementById('currentPosition');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectBLEBtn = document.getElementById('connectBLE');
        const disconnectBLEBtn = document.getElementById('disconnectBLE');
        const bleDevicesSection = document.getElementById('bleDevices');
        const bleDeviceList = document.getElementById('bleDeviceList');
        const connectToDeviceBtn = document.getElementById('connectToDevice');
        const setSpeedBLEBtn = document.getElementById('setSpeedBLE');
        const setSpeedWiFiBtn = document.getElementById('setSpeedWiFi');
        const refreshStatusBtn = document.getElementById('refreshStatus');
        
        // Update speed display when slider changes
        speedControl.addEventListener('input', function() {
            speedDisplay.textContent = this.value;
        });
        
        // Initialize WebSocket connection
        function initWebSocket() {
            const esp32IP = window.location.hostname;
            webSocket = new WebSocket(`ws://${esp32IP}/ws`);
            
            webSocket.onopen = function() {
                console.log('WebSocket connected');
                updateConnectionStatus('WebSocket Connected', 'connected');
            };
            
            webSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.speed !== undefined) {
                    currentSpeed.textContent = data.speed.toFixed(2);
                }
                if (data.position !== undefined) {
                    currentPosition.textContent = data.position.toFixed(2);
                }
            };
            
            webSocket.onclose = function() {
                console.log('WebSocket disconnected');
                updateConnectionStatus('Disconnected', 'disconnected');
                setTimeout(initWebSocket, 2000);
            };
        }
        
        // Set speed via WiFi
        setSpeedWiFiBtn.addEventListener('click', function() {
            const speed = parseInt(speedControl.value);
            fetch('/setSpeed?value=' + speed)
                .then(response => response.text())
                .then(data => console.log(data))
                .catch(error => console.error('Error:', error));
        });
        
        // Refresh status
        refreshStatusBtn.addEventListener('click', function() {
            fetch('/speed')
                .then(response => response.text())
                .then(speed => {
                    currentSpeed.textContent = speed;
                });
        });
        
        // BLE Functions
        connectBLEBtn.addEventListener('click', async function() {
            try {
                if (!navigator.bluetooth) {
                    throw new Error('Web Bluetooth not supported');
                }
                
                bleDevicesSection.classList.remove('hidden');
                connectBLEBtn.disabled = true;
                
                const devices = await navigator.bluetooth.requestDevice({
                    filters: [{ name: "ESP32 Motor Controller" }],
                    optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
                });
                
                bleDeviceList.innerHTML = '';
                if (devices) {
                    const option = document.createElement('option');
                    option.value = devices.id;
                    option.textContent = devices.name || devices.id;
                    bleDeviceList.appendChild(option);
                }
                
            } catch (error) {
                console.error('Error:', error);
                alert('Bluetooth error: ' + error.message);
                bleDevicesSection.classList.add('hidden');
                connectBLEBtn.disabled = false;
            }
        });
        
        connectToDeviceBtn.addEventListener('click', async function() {
            try {
                const deviceId = bleDeviceList.value;
                if (!deviceId) return;
                
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b'] }]
                });
                
                if (!bleDevice) return;
                
                bleServer = await bleDevice.gatt.connect();
                bleService = await bleServer.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
                
                speedCharacteristic = await bleService.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');
                encoderCharacteristic = await bleService.getCharacteristic('cba1d466-344c-4be3-ab3f-189f80dd7518');
                
                // Listen for encoder updates
                encoderCharacteristic.addEventListener('characteristicvaluechanged', handleEncoderData);
                await encoderCharacteristic.startNotifications();
                
                updateConnectionStatus('BLE Connected', 'connected');
                connectBLEBtn.classList.add('hidden');
                disconnectBLEBtn.classList.remove('hidden');
                bleDevicesSection.classList.add('hidden');
                
            } catch (error) {
                console.error('Error:', error);
                alert('Connection error: ' + error.message);
            }
        });
        
        disconnectBLEBtn.addEventListener('click', function() {
            if (bleDevice && bleDevice.gatt.connected) {
                bleDevice.gatt.disconnect();
            }
            updateConnectionStatus('Disconnected', 'disconnected');
            connectBLEBtn.classList.remove('hidden');
            disconnectBLEBtn.classList.add('hidden');
            connectBLEBtn.disabled = false;
        });
        
        // Set speed via BLE
        setSpeedBLEBtn.addEventListener('click', async function() {
            if (!speedCharacteristic) {
                alert('Not connected to BLE device');
                return;
            }
            
            const speed = parseInt(speedControl.value);
            const value = new Uint8Array([speed]);
            
            try {
                await speedCharacteristic.writeValue(value);
                console.log('Speed set via BLE:', speed);
            } catch (error) {
                console.error('Error setting speed:', error);
                alert('Failed to set speed: ' + error.message);
            }
        });
        
        function handleEncoderData(event) {
            const value = event.target.value;
            const textDecoder = new TextDecoder();
            const data = textDecoder.decode(value).split(',');
            
            if (data.length >= 2) {
                currentPosition.textContent = parseFloat(data[0]).toFixed(2);
                currentSpeed.textContent = parseFloat(data[1]).toFixed(2);
            }
        }
        
        function updateConnectionStatus(text, status) {
            connectionStatus.textContent = text;
            connectionStatus.className = 'connection-status ' + status;
        }
        
        // Initialize
        initWebSocket();
        
        // Auto-refresh status every second
        setInterval(() => {
            fetch('/speed')
                .then(response => response.text())
                .then(speed => {
                    currentSpeed.textContent = speed;
                });
        }, 1000);
    </script>
</body>
</html>
